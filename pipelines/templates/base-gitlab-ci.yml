variables:
  DOCKER_SEMREL: registry.gitlab.com/juhani/go-semrel-gitlab:v0.21.1
  DOCKER_GIT: samueldebruyn/debian-git


stages:
  - Validate
  - BuildNumber
  - Build
  - TagBuildNumber

# Templates
#######################################################################################

.build_template:
  stage: Build

.build_number_template:
  stage: BuildNumber
  image: $DOCKER_GIT
  environment:
    name: development
  script:
    - git rev-list --count origin/master > .build_number
    - echo "Build number:"$(cat .build_number)
  artifacts:
    paths:
      - .build_number

## Merge jobs
#######################################################################################

.lint_mr_template:
  stage: Validate
  only:
    - merge_requests

.test_mr_template:
  stage: Validate
  only:
    - merge_requests

# Jobs
#######################################################################################

## Merge Requests
#######################################################################################

BuildNumber:
  extends: .build_number_template
  only:
    - merge_requests
  script:
    - git rev-list --count $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME > .build_number
    - echo "Build number:"$(cat .build_number)
  artifacts:
    paths:
      - .build_number

## Master
#######################################################################################

BuildNumber:
  extends: .build_number_template
  only:
    - master
  script:
    - git rev-list --count origin/master > .build_number
    - echo "Build number:"$(cat .build_number)
  artifacts:
    paths:
      - .build_number

TagBuildNumber:
  stage: TagBuildNumber
  image: $DOCKER_GIT
  environment:
    name: development
  only:
    - master
  script:
    - BUILD_NUMBER=`cat .build_number`
    - echo "Build number $BUILD_NUMBER"

    - git tag builds/$BUILD_NUMBER
    - git remote set-url origin https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/$CI_PROJECT_PATH.git/
    - git push origin builds/$BUILD_NUMBER



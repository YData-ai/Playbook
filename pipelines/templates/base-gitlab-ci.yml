variables:
  DOCKER_SEMREL: registry.gitlab.com/juhani/go-semrel-gitlab:v0.21.1
  DOCKER_GIT: samueldebruyn/debian-git
  PREFIX_TAG_BUILDS: builds

stages:
  - Validate
  - BuildNumber
  - Build
  - TagBuildNumber
  - Docker
  
# Templates
#######################################################################################

.build_template:
  stage: Build

.build_number_template:
  stage: BuildNumber
  image: $DOCKER_GIT
  artifacts:
    paths:
      - .build_number

.docker_template:
  stage: Docker
  image: docker:stable
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  services:
    - docker:19.03.0-dind
  script:
    - BUILD_NUMBER=$(cat .build_number)
    - 'echo Building docker image for: $BUILD_NUMBER'
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/$CI_PROJECT_PATH/$REGISTRY_PATH:$BUILD_NUMBER .
    - docker push $CI_REGISTRY/$CI_PROJECT_PATH/$REGISTRY_PATH:$BUILD_NUMBER  

## Merge templates
#######################################################################################

.lint_mr_template:
  stage: Validate
  only:
    - merge_requests

.test_mr_template:
  stage: Validate
  only:
    - merge_requests

# Jobs
#######################################################################################

## Master jobs
#######################################################################################

BuildNumber:
  extends: .build_number_template
  only:
    - master
  script:
    - git rev-list --count HEAD > .build_number
    - 'echo Calculated build number: $(cat .build_number)'
  artifacts:
    paths:
      - .build_number

TagBuildNumber:
  stage: TagBuildNumber
  image: $DOCKER_GIT
  only:
    - master
  script:
    - BUILD_NUMBER=$(cat .build_number)
    - 'echo Using build number: $BUILD_NUMBER'
    - git tag $PREFIX_TAG_BUILDS/$BUILD_NUMBER
    - git push --repo https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/$CI_PROJECT_PATH.git/ $PREFIX_TAG_BUILDS/$BUILD_NUMBER

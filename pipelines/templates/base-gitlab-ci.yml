variables:
  DOCKER_SEMREL: registry.gitlab.com/juhani/go-semrel-gitlab:v0.21.1
  DOCKER_GIT: samueldebruyn/debian-git
  DOCKER_SIMPLE: alpine:3.11
  PREFIX_TAG_BUILDS: build
  PREFIX_TAG_RELEASE: release

stages:
  - Validate
  - BuildNumber
  - Build
  - Docker
  - Deploy
  - TagBuildNumber
  - TagVersion
  
# Templates
#######################################################################################

.build_template:
  stage: Build
  except:
    - branches

.build_number_template:
  stage: BuildNumber
  except:
    - branches
  artifacts:
    paths:
      - .build_number

.docker_template:
  stage: Docker
  image: docker:stable
  except:
    - branches
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  services:
    - docker:19.03.0-dind
  script:
    - BUILD_NUMBER=$(cat .build_number)
    - 'echo Building docker image for: $BUILD_NUMBER'
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/$CI_PROJECT_PATH/$REGISTRY_PATH:$BUILD_NUMBER .
    - docker push $CI_REGISTRY/$CI_PROJECT_PATH/$REGISTRY_PATH:$BUILD_NUMBER  

.deploy_template:
  stage: Deploy
  except:
    - branches

## Merge templates
#######################################################################################

.lint_mr_template:
  stage: Validate
  except:
    - branches
  only:
    - merge_requests

.test_mr_template:
  stage: Validate
  except:
    - branches
  only:
    - merge_requests

# Jobs
#######################################################################################

## Master jobs
#######################################################################################

BuildNumber:
  extends: .build_number_template
  only:
    - master
  script:
    - git rev-list --count HEAD > .build_number
    - 'echo Calculated build number: $(cat .build_number)'

TagBuildNumber:
  stage: TagBuildNumber
  image: $DOCKER_GIT
  only:
    - master
  script:
    - BUILD_NUMBER=$(cat .build_number)
    - 'echo Using build number: $BUILD_NUMBER'
    - git tag $PREFIX_TAG_BUILDS/$BUILD_NUMBER
    - git push https://gitlab-ci-token:$CI_PUSH_TOKEN@gitlab.com/$CI_PROJECT_PATH.git/ $PREFIX_TAG_BUILDS/$BUILD_NUMBER

TagVersion:
  stage: TagVersion
  image: $DOCKER_SEMREL
  variables:
    GSG_TAG_PREFIX: $PREFIX_TAG_RELEASE
  when: manual
  only:
    - master
  script: 
    - echo $GSG_TAG_PREFIX
    - release next-version
    - release tag


## Build jobs
#######################################################################################

BuildNumberFromBuildTAG:
  extends: .build_number_template
  image: $DOCKER_SIMPLE
  environment:
    name: development
  only:
    - /build/
  script:
    - echo $CI_COMMIT_TAG | sed -n -E 's/build\/([0-9]+)/\1/p' > .build_number
    - echo "Build number "$(cat .build_number)
  
BuildDockerForBuildTag:
  extends: .docker_template
  variables:
    REGISTRY_PATH: $PREFIX_TAG_BUILDS
  only:
    - /build/


## Release jobs
#######################################################################################

BuildNumberFromReleaseTAG:
  extends: .build_number_template
  image: $DOCKER_SIMPLE
  environment:
    name: production
  only:
    - /release/
  script:
    - echo $CI_COMMIT_TAG | sed -n -E 's/release\/([0-9]+.[0-9]+.[0-9]+)/\1/p' > .build_number
    - echo "Build number "$(cat .build_number)

BuildDockerForBuildTag:
  extends: .docker_template
  variables:
    REGISTRY_PATH: $PREFIX_TAG_RELEASE
  only:
    - /release/
